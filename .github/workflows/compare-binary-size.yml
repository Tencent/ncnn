name: compare-binary-size
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  compare-size:
    runs-on: ubuntu-latest
    steps:
      - name: Check out PR branch
        uses: actions/checkout@v4
        with:
          # 拉取拉取请求的源分支
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Build PR branch
        run: |
          mkdir -p build_pr && cd build_pr
          cmake -DNCNN_SHARED_LIB=ON -DNCNN_VULKAN=ON ..
          cmake --build . -j 4
          PR_SIZE=$(stat -c%s "src/libncnn.so")
          echo "PR_SIZE=${PR_SIZE}" >> $GITHUB_ENV

      - name: Check out base branch
        uses: actions/checkout@v4
        with:
          # 拉取拉取请求的目标(base)分支
          ref: ${{ github.event.pull_request.base.ref }}
          repository: ${{ github.event.pull_request.base.repo.full_name }}

      - name: Build base branch
        run: |
          mkdir -p build_base && cd build_base
          cmake -DNCNN_SHARED_LIB=ON -DNCNN_VULKAN=ON ..
          cmake --build . -j 4
          BASE_SIZE=$(stat -c%s "src/libncnn.so")
          echo "BASE_SIZE=${BASE_SIZE}" >> $GITHUB_ENV

      - name: Compare binary size
        run: |
          echo "PR branch libncnn.so size:      $PR_SIZE bytes"
          echo "Base branch libncnn.so size:    $BASE_SIZE bytes"
          DIFF=$((PR_SIZE - BASE_SIZE))
          if [ $DIFF -gt 0 ]; then
            echo "New build is larger by $DIFF bytes."
          elif [ $DIFF -lt 0 ]; then
            ABS=$((0 - DIFF))
            echo "New build is smaller by $ABS bytes."
          else
            echo "Binary size is unchanged."
